#!/usr/bin/env bash

docker build -t dockerbot -f dockerfiles/Dockerfile .
docker tag -f dockerbot dockerbot:production
docker tag -f dockerbot dockerbot:${GIT_COMMIT}
docker tag -f dockerbot localhost:5000/dockerbot
docker tag -f dockerbot localhost:5000/dockerbot:production
docker tag -f dockerbot localhost:5000/dockerbot:${GIT_COMMIT}
docker push localhost:5000/dockerbot
docker push localhost:5000/dockerbot:production
docker push localhost:5000/dockerbot:${GIT_COMMIT}

docker rm dockerbot &> /dev/null || echo 'No dockerbot container found to remove. Continuing.'

docker run \
  --detach \
  --publish 8088:8080 \
  --name dockerbot \
  --restart always \
  --net dockerbot \
  --env "REDIS_URL=redis://redis.dockerbot:6379" \
  --env "HUBOT_SLACK_TOKEN=xoxb-17520427908-lCKXDp3941tbAdXu3jhRA7EO" \
  localhost:5000/dockerbot:production

docker rmi $(docker images -q --filter "dangling=true") &> /dev/null || echo 'No images to clean.'
